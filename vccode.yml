version: "3"

vars:
  VSC_FRAGMENT: |
    {
      "files.autoSave": "afterDelay",
      "files.autoSaveDelay": 1000,
      "editor.formatOnSave": true,
      "editor.tabSize": 2,
      "editor.insertSpaces": true,
      "editor.wordWrap": "on",
      "workbench.colorTheme": "Abyss",
      "terminal.integrated.defaultProfile.linux": "bash",
      "security.workspace.trust.enabled": false,
      "explorer.confirmDelete": false,
      "git.autofetch": true,
      "editor.minimap.enabled": false,
      "workbench.startupEditor": "none",
      "github.copilot.enable": {
        "*": false,
        "plaintext": false,
        "markdown": false,
        "scminput": false
      }
    }

tasks:
  04:vs-code-configure:
    desc: "Configure VS Code settings (Ubuntu)"
    cmds:
      - |
        #!/usr/bin/env bash

        # Check if jq is available
        if ! command -v jq &> /dev/null; then
          echo "Error: jq is required but not installed"
          echo "Install with: sudo apt-get install jq"
          exit 1
        fi

        VSC_DIR="$HOME/.config/Code/User"
        VSC_SETTINGS="$VSC_DIR/settings.json"
        
        echo "Configuring VS Code settings..."
        mkdir -p "$VSC_DIR"

        # Create backup if file exists
        if [[ -f "$VSC_SETTINGS" ]]; then
          BACKUP_FILE="$VSC_SETTINGS.backup.$(date +%s)"
          cp "$VSC_SETTINGS" "$BACKUP_FILE"
          echo "Created backup: $BACKUP_FILE"
          
          # Merge with existing settings
          if jq --argjson frag '{{.VSC_FRAGMENT}}' '. + $frag' "$VSC_SETTINGS" > "$VSC_SETTINGS.tmp"; then
            mv "$VSC_SETTINGS.tmp" "$VSC_SETTINGS"
            echo "Merged settings with existing configuration"
          else
            echo "Error merging settings"
            rm -f "$VSC_SETTINGS.tmp"
            exit 1
          fi
        else
          # Create new settings file
          if printf '%s\n' '{{.VSC_FRAGMENT}}' > "$VSC_SETTINGS"; then
            echo "Created new settings file"
          else
            echo "Error creating settings file"
            exit 1
          fi
        fi

        echo "Updated $VSC_SETTINGS"
        echo "Settings applied:"
        echo '{{.VSC_FRAGMENT}}' | jq -r 'keys[] | "  • " + .'

  04:vs-code-undo:
    desc: "Reset only the keys set by this Task (Ubuntu)"
    cmds:
      - |
        #!/usr/bin/env bash

        # Check if jq is available
        if ! command -v jq &> /dev/null; then
          echo "Error: jq is required but not installed"
          exit 1
        fi

        VSC_DIR="$HOME/.config/Code/User"
        VSC_SETTINGS="$VSC_DIR/settings.json"

        if [[ ! -f "$VSC_SETTINGS" ]]; then
          echo "No settings.json found. Nothing to undo."
          exit 0
        fi

        echo "Undoing VS Code configuration..."
        
        # Create backup before undoing
        BACKUP_FILE="$VSC_SETTINGS.backup.$(date +%s)"
        cp "$VSC_SETTINGS" "$BACKUP_FILE"
        echo "Created backup: $BACKUP_FILE"

        # Remove only the top-level keys present in VSC_FRAGMENT
        if jq --argjson frag '{{.VSC_FRAGMENT}}' \
           'reduce ($frag | keys[]) as $k (. ; del(.[$k]))' \
           "$VSC_SETTINGS" > "$VSC_SETTINGS.tmp"; then
          mv "$VSC_SETTINGS.tmp" "$VSC_SETTINGS"
          echo "Removed configured keys from $VSC_SETTINGS"
          echo "Removed settings:"
          echo '{{.VSC_FRAGMENT}}' | jq -r 'keys[] | "  • " + .'
        else
          echo "Error removing settings"
          rm -f "$VSC_SETTINGS.tmp"
          exit 1
        fi

  help:
    desc: "Show available tasks"
    cmds:
      - task --list
