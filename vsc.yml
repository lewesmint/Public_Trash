version: "3"

tasks:
  vscode:verify:
    desc: "Verify VS Code apt source and keyring are correct"
    cmds:
      - |
        KEYRING="/etc/apt/keyrings/microsoft.gpg"
        LISTFILE="/etc/apt/sources.list.d/vscode.list"
        URL="https://packages.microsoft.com/repos/code"
        CANONICAL="deb [arch=amd64,arm64,armhf signed-by=$KEYRING] $URL stable main"

        echo ">>> Checking repo file exists…"
        if [ ! -f "$LISTFILE" ]; then
          echo "✗ $LISTFILE missing"
          exit 1
        fi

        echo ">>> Checking for duplicate or stray entries…"
        COUNT=$(grep -R -E "\s$URL\s" /etc/apt/sources.list /etc/apt/sources.list.d/*.list /etc/apt/sources.list.d/*.sources 2>/dev/null | wc -l)
        if [ "$COUNT" -ne 1 ]; then
          echo "✗ Found $COUNT entries referencing $URL (expected 1). Run: task vscode:cleanup && task vscode:install"
          grep -R -n -E "\s$URL\s" /etc/apt/sources.list /etc/apt/sources.list.d /etc/apt/sources.list.d/*.sources || true
          exit 1
        fi

        echo ">>> Validating canonical line in $LISTFILE…"
        if grep -qxF "$CANONICAL" "$LISTFILE"; then
          echo "✓ Repo line is canonical"
        else
          echo "✗ Repo line differs from canonical. Current:"
          cat "$LISTFILE"
          echo "→ Expected exactly:"
          echo "$CANONICAL"
          exit 1
        fi

        echo ">>> Checking keyring presence and perms…"
        if [ -r "$KEYRING" ]; then
          echo "✓ Keyring present and readable: $KEYRING"
        else
          echo "✗ Keyring missing or unreadable: $KEYRING"
          exit 1
        fi

        echo ">>> Dry-run apt update against the Code repo…"
        # Limit output to the Code repo line to avoid noise
        sudo apt-get update -o Dir::Etc::sourcelist="$LISTFILE" -o Dir::Etc::sourceparts="-" -o APT::Get::List-Cleanup="0" >/dev/null && \
          echo "✓ APT can read and verify the repo" || { echo "✗ APT update failed for the Code repo"; exit 1; }

        echo "✔ VS Code source looks good."
