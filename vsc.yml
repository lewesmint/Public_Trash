version: "3"

tasks:
  vscode:install:
    desc: "Install Visual Studio Code (idempotent)"
    cmds:
      - |
        # Vars
        KEYRING="/etc/apt/keyrings/microsoft.gpg"
        LISTFILE="/etc/apt/sources.list.d/vscode.list"
        URL="https://packages.microsoft.com/repos/code"
        REPO_LINE="deb [arch=amd64,arm64,armhf signed-by=$KEYRING] $URL stable main"

        echo ">>> Installing prerequisites..."
        sudo apt-get update -y
        sudo apt-get install -y wget gpg apt-transport-https

        echo ">>> Ensuring keyrings directory exists..."
        sudo install -d -m 0755 /etc/apt/keyrings

        echo ">>> Installing Microsoft signing key (if missing)..."
        if [ ! -f "$KEYRING" ]; then
          wget -qO- https://packages.microsoft.com/keys/microsoft.asc \
            | gpg --dearmor \
            | sudo tee "$KEYRING" >/dev/null
          sudo chmod 0644 "$KEYRING"
        fi

        echo ">>> Removing any old/conflicting repo lines..."
        for f in /etc/apt/sources.list /etc/apt/sources.list.d/*.list /etc/apt/sources.list.d/*.sources; do
          [ -f "$f" ] || continue
          sudo sed -i "\|$URL|d" "$f" || true
        done
        sudo rm -f /etc/apt/sources.list.d/vscode.list /etc/apt/sources.list.d/vscode.list.save || true

        echo ">>> Writing canonical repo line..."
        echo "$REPO_LINE" | sudo tee "$LISTFILE" >/dev/null

        echo ">>> Installing/updating VS Code..."
        sudo apt-get update -y
        sudo apt-get install -y code

        echo "✔ VS Code installed (idempotent)."

  vscode:uninstall:
    desc: "Uninstall VS Code and scrub all repo entries"
    cmds:
      - |
        KEYRING="/etc/apt/keyrings/microsoft.gpg"
        URL="https://packages.microsoft.com/repos/code"

        echo ">>> Purging VS Code package..."
        sudo apt-get purge -y code || true
        sudo apt-get autoremove -y || true

        echo ">>> Removing repo entries..."
        for f in /etc/apt/sources.list /etc/apt/sources.list.d/*.list /etc/apt/sources.list.d/*.sources; do
          [ -f "$f" ] || continue
          sudo sed -i "\|$URL|d" "$f" || true
        done
        sudo rm -f /etc/apt/sources.list.d/vscode.list /etc/apt/sources.list.d/vscode.list.save || true

        echo ">>> Removing Microsoft keyring (optional)..."
        sudo rm -f "$KEYRING" || true

        echo ">>> Refreshing APT indices..."
        sudo apt-get update -y || true

        echo "✔ VS Code uninstalled and repo scrubbed."

  vscode:status:
    desc: "Check if VS Code is installed and repo present"
    cmds:
      - |
        KEYRING="/etc/apt/keyrings/microsoft.gpg"
        LISTFILE="/etc/apt/sources.list.d/vscode.list"

        echo "=== VS Code Status ==="
        if dpkg -s code >/dev/null 2>&1; then
          echo "✔ VS Code installed: $(code --version | head -n1)"
        else
          echo "✗ VS Code not installed"
        fi

        if [ -f "$LISTFILE" ]; then
          echo "✔ Repo file exists at $LISTFILE"
          grep -q "packages.microsoft.com/repos/code" "$LISTFILE" \
            && echo "   Repo line is valid" \
            || echo "   Repo line looks unusual"
        else
          echo "✗ Repo file not present"
        fi

        if [ -f "$KEYRING" ]; then
          echo "✔ Keyring present at $KEYRING"
        else
          echo "✗ Keyring missing"
        fi

  vscode:grep:
    desc: "List any apt source files still containing VS Code repo lines"
    cmds:
      - |
        grep -R --line-number -E 'packages\.microsoft\.com/.*/code' \
          /etc/apt/sources.list /etc/apt/sources.list.d /etc/apt/sources.list.d/*.sources || true
