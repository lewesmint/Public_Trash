version: '3'

tasks:
  docker:install:
    cmds:
      - |
        # Add Dockerâ€™s GPG key if missing
        sudo install -m 0755 -d /etc/apt/keyrings
        if [ ! -f /etc/apt/keyrings/docker.gpg ]; then
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg \
            | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
          sudo chmod a+r /etc/apt/keyrings/docker.gpg
        fi

        # Add Docker APT repo if not already present
        source /etc/os-release
        ARCH="$(dpkg --print-architecture)"
        LINE="deb [arch=${ARCH} signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu ${VERSION_CODENAME} stable"
        LIST=/etc/apt/sources.list.d/docker.list

        if [ ! -f "$LIST" ] || ! grep -qF "$LINE" "$LIST"; then
          echo "$LINE" | sudo tee "$LIST" >/dev/null
        fi
      - sudo apt-get update -y
      - sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
      - sudo systemctl enable --now docker
